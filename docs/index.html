<!DOCTYPE html><html lang="en"><head>
      

        <title>Drive</title>
        <meta name="Description" content="Drive: Functional Reactive Form Validation in iOS with RxSwift by Scott Orlyck">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta charset="utf-8">
        <meta name="twitter:title" content="Drive">
        <meta name="twitter:description" content="Functional Reactive Form Validation in iOS with RxSwift">
        <meta name="twitter:image" content="https://raw.githubusercontent.com/ScottORLY/drive-blog/main/src/drive.jpg">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="https://scottorly.github.io/drive-blog/">
        <meta name="twitter:creator" content="@orlyck">
        <meta property="og:url" content="https://scottorly.github.io/drive-blog/">
        <meta property="og:title" content="Drive">
        <meta property="og:description" content="Functional Reactive Form Validation in iOS with RxSwift">
        <meta property="og:image" content="https://raw.githubusercontent.com/ScottORLY/drive-blog/main/src/drive.jpg">
        <meta property="og:image:secure" content="https://raw.githubusercontent.com/ScottORLY/drive-blog/main/src/drive.jpg">
    <style type="text/css">@import url("https://fonts.googleapis.com/css2?family=Nunito:wght@400&display=swap");@import url("https://fonts.googleapis.com/css2?family=Michroma&display=swap");@import url("https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap");code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}html{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:#f3f4f6;background-color:rgba(243,244,246,var(--tw-bg-opacity));color:#111827;color:rgba(17,24,39,var(--tw-text-opacity));font-family:Nunito,sans-serif}#app{display:flex;flex-direction:column;margin-bottom:3rem;padding-left:.25rem;padding-right:.25rem}#app,.img{margin-left:auto;margin-right:auto;max-width:100%}.img{border-radius:.5rem;float:right;-o-object-fit:contain;object-fit:contain}.fullBleed{left:50%;margin-left:-50vw;margin-right:-50vw;position:relative;right:50%;width:100vw}h2{margin-bottom:2rem;margin-top:2rem}code.centered{display:block}h1,h2{font-family:Michroma,sans-serif}.centered{margin:.75rem auto;max-width:48rem}p{text-indent:1.5rem}.gist{margin-bottom:.75rem;margin-top:.75rem}.noIndent{text-indent:0}.right{float:right;margin-left:1rem}.inlineCode{display:inline}.code,.inlineCode{font-size:.75rem;line-height:1rem}.code{left:50%;margin-bottom:3rem;margin-left:-50vw;margin-right:-50vw;margin-top:3rem;position:relative;right:50%;width:100vw}.list{list-style-type:none}a{text-decoration:none}a:hover{text-decoration:underline}code[class*=language-],pre[class*=language-]{font-family:Source Code Pro,sans-serif,monospace!important}@media (min-width:768px){#app{padding-left:2rem;padding-right:2rem}p{font-size:1.25rem;line-height:1.75rem}.code,.inlineCode{font-size:.875rem;line-height:1.25rem}}@media screen and (min-width:1600px){.fullBleed{margin-left:auto;margin-right:auto;max-width:1600px;position:static}}</style></head>
    
<body>
<div id="app"><div class="centered"><h1 class="centered"><i>Drive</i></h1><h2>Functional Reactive Form Validation in iOS with RxSwift</h2><h3>by <a href="https://github.com/scottorly">Scott Orlyck</a></h3><p>last updated: 11/15/2021</p></div><img class="fullBleed" src="https://raw.githubusercontent.com/scottorly/drive/main/src/drive.webp" alt="Ryan Gosling with a Dispose Bag"><div class="centered"><p><a href="https://www.youtube.com/watch?v=KBiOF3y1W0Y"><i>Drive</i></a></p><h2>Introduction</h2><p>This blog post is intended for readers with some measure of familiarity with iOS development, functional reactive programming and alternative iOS architecture patterns. If not here are some resources to get started.<ul class="list"><li><a href="http://reactivex.io/">ReactiveX</a></li><li><a href="https://github.com/ReactiveX/RxSwift">RxSwift</a></li><li><a href="https://www.raywenderlich.com/34-design-patterns-by-tutorials-mvvm">MVVM</a></li></ul></p><h2>Why Drive?</h2><p>SwiftUI has been getting all the love since it was announced but I want to take some time to write about the productivity benefits of functional reactive programming using RxSwift when combined with the stability of UIKit.</p><p>Observables are an excellent data-binding mechanism when escaping target-action, delegate based MVC patterns but even after the steep learning curve remembering tedious boilerplate and dodging footguns can be time consuming and error prone. Furthermore type inference across API boundaries can result in frustrating fights with the Swift compiler.</p><p>An example from the RxSwift documentation is an effective demonstration of the implementation complexity faced when using Rx with UIKit properly.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">let</span> results <span class="token operator">=</span> query<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>text
    <span class="token punctuation">.</span><span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">:</span> <span class="token class-name">MainScheduler</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span> query <span class="token keyword">in</span>
        <span class="token function">fetchAutoCompleteItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">observeOn</span><span class="token punctuation">(</span><span class="token class-name">MainScheduler</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span>  <span class="token comment">// results are returned on MainScheduler</span>
            <span class="token punctuation">.</span><span class="token function">catchErrorJustReturn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment">// in the worst case, errors are handled</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span>replay<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span>                           <span class="token comment">// HTTP requests are shared and results replayed</span>
                                                <span class="token comment">// to all UI elements</span>

results
    <span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token short-argument">$0</span><span class="token punctuation">.</span>count</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> resultCount<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> disposeBag<span class="token punctuation">)</span></code></pre></div><p>Thankfully RxSwift provides us with some wrappers around common UI patterns that can help simplify implementations. RxSwift calls these wrappers <a hre="https://github.com/ReactiveX/RxSwift/blob/main/Documentation/Traits.md">traits</a> and today we are going to focus on the <a href="https://github.com/ReactiveX/RxSwift/blob/main/Documentation/Traits.md#driver">Driver</a> trait.</p><p>RxSwift Traits are simple structs that implement the builder pattern to return an observable sequence guaranteed to have certain properties. The Driver trait guarantees three properties that happen to be integral to correct UI implementations: events are observed on the main thread, the observable sequence can't error out, and side effects are shared so that each subscription will share the same computational resources.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">let</span> safeSequence <span class="token operator">=</span> xs
    <span class="token punctuation">.</span><span class="token function">observeOn</span><span class="token punctuation">(</span><span class="token class-name">MainScheduler</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span>        <span class="token comment">// observe events on main scheduler</span>
    <span class="token punctuation">.</span><span class="token function">catchErrorJustReturn</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">)</span>  <span class="token comment">// can't error out</span>
    <span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span>replay<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> scope<span class="token punctuation">:</span> <span class="token punctuation">.</span>whileConnected<span class="token punctuation">)</span> <span class="token comment">// side effects sharing</span>

<span class="token keyword">return</span> <span class="token class-name">Driver</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> safeSequence<span class="token punctuation">)</span>            <span class="token comment">// wrap it up</span>

<span class="token keyword">let</span> results <span class="token operator">=</span> query<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">// This converts a normal sequence into a 'Driver' sequence.</span>
    <span class="token punctuation">.</span><span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">:</span> <span class="token class-name">MainScheduler</span><span class="token punctuation">.</span>instance<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span> query <span class="token keyword">in</span>
        <span class="token function">fetchAutoCompleteItems</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// Builder just needs info about what to return in case of error.</span>
    <span class="token punctuation">}</span>

results
    <span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token string-literal"><span class="token string">"($0.count)"</span></span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span>resultCount<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>text<span class="token punctuation">)</span>            <span class="token comment">// If there is a 'drive' method available instead of 'bind(to:)',</span>
    <span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> disposeBag<span class="token punctuation">)</span>              <span class="token comment">// that means that the compiler has proven that all properties</span>
                                           <span class="token comment">// are satisfied.</span></code></pre></div><p class="noIndent">Let's take a closer look at a practical example.</p><h2>Real Time UITextField Validation</h2><div><img class="img" src="https://raw.githubusercontent.com/ScottORLY/drive-blog/main/src/validation.gif" alt="animated gif of text field validation"><div><p>Form validation that provides the user with immediate feedback if a text field meets predefined requirements is a common UX pattern and this example will show you how you can use the Driver trait for effective results with a very small amount of clean, testable code.</p><h2>Braking Zone</h2><p>For the purpose of narrowing the focus of this article I won't be going over project setup, how to connect outlets in storyboards, the basics of RxSwift/RxCocoa etc. I will also be handwaving the networking, validation and network activity tracking utilities as those implementation details are outside the scope of this article. The working project source code is available <a href="https://github.com/ScottORLY/drive">here</a> if you would like to take a closer look or test a working example on a simulator or device.</p></div></div><p>This project will use MVVM but there are a few ground rules to help enforce seperation of concerns:<ol type="1" class="list"><li>The ViewModel can never import UIKit or reference the ViewController.</li><li>The ViewModel will never subscribe to an observable.</li><li>The ViewController will never directly call any methods defined on the ViewModel.</li></ol></p><p>First we define inputs to the ViewModel. The initializer for our new ViewModel class below takes a pair of <span class="inlineCode"><code class="  language-swift"><span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span></code></span> for the email and password and a <span class="inlineCode"><code class="  language-swift"><span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Void</span><span class="token operator">&gt;</span></code></span> for the sign in button tap. We are not going to explicitly store references to these sequences.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">import</span> <span class="token class-name">Foundation</span>
<span class="token keyword">import</span> <span class="token class-name">RxSwift</span>
<span class="token keyword">import</span> <span class="token class-name">RxCocoa</span>

<span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{</span>
  
    <span class="token comment">//MARK: - Inputs</span>
  
    <span class="token keyword">init</span><span class="token punctuation">(</span>
        email<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        signIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Void</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>In the ViewController we initialize the ViewModel passing in the Observables from the IBOutlets. Note the call to <span class="inlineCode"><code class="  language-swift"><span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></span> to build the Drivers from the ControlEvent observables.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">import</span> <span class="token class-name">UIKit</span>
<span class="token keyword">import</span> <span class="token class-name">RxSwift</span>
<span class="token keyword">import</span> <span class="token class-name">RxCocoa</span>

<span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span>

    <span class="token comment">// MARK: - IBOutlets</span>

    <span class="token attribute atrule">@IBOutlet</span> <span class="token keyword">weak</span> <span class="token keyword">var</span> email<span class="token punctuation">:</span> <span class="token class-name">UITextField</span><span class="token operator">!</span>
    <span class="token attribute atrule">@IBOutlet</span> <span class="token keyword">weak</span> <span class="token keyword">var</span> password<span class="token punctuation">:</span> <span class="token class-name">UITextField</span><span class="token operator">!</span>
    <span class="token attribute atrule">@IBOutlet</span> <span class="token keyword">weak</span> <span class="token keyword">var</span> signIn<span class="token punctuation">:</span> <span class="token class-name">UIButton</span><span class="token operator">!</span>
    
    <span class="token keyword">lazy</span> <span class="token keyword">var</span> viewModel<span class="token punctuation">:</span> <span class="token class-name">ViewModel</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token class-name">ViewModel</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> email<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>text<span class="token punctuation">.</span>orEmpty<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  password<span class="token punctuation">:</span> password<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>text<span class="token punctuation">.</span>orEmpty<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  signIn<span class="token punctuation">:</span> signIn<span class="token punctuation">.</span>rx<span class="token punctuation">.</span>tap<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span></code></pre></div><p>Next we define output properties to store the reference to the result of the operator transformations we are going to perform on the input observables.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{</span>
  
    <span class="token comment">//MARK: - Outputs</span>

    <span class="token keyword">let</span> validatedEmail<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Validation</span><span class="token operator">&gt;</span>
    <span class="token keyword">let</span> validatedPassword<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Validation</span><span class="token operator">&gt;</span>
  
    <span class="token comment">//MARK: - Inputs</span>
  
    <span class="token keyword">init</span><span class="token punctuation">(</span>
          email<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
          password<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
          signIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Void</span><span class="token operator">&gt;</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> validation <span class="token operator">=</span> <span class="token class-name">ValidationService</span><span class="token punctuation">.</span>shared
      
          validatedEmail <span class="token operator">=</span> <span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token function">combineLatest</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> signIn<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span>
              validation<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Email required."</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          validatedPassword <span class="token operator">=</span> <span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token function">combineLatest</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> signIn<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span>
              validation<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Password required."</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>Above we are using <a href="http://reactivex.io/documentation/operators/combinelatest.html"><span class="inlineCode"><code class="  language-swift"><span class="token class-name">Driver</span><span class="token punctuation">.</span>combineLatest</code></span></a> to combine events from the UITextField Drivers and the sign in button tap. The purpose of this is to exploit a behavior of combine latest that the result observable will not emit an event until both source observables have at least one in order to prevent displaying validation errors before user interaction. Then we <span class="inlineCode"><code class="  language-swift"><span class="token punctuation">.</span>flatMapLatest</code></span> the combined text and tap events passing the string into our validation service's appropriate validation method and return a <span class="inlineCode"><code class="  language-swift"><span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Validation</span><span class="token operator">&gt;</span></code></span> that is stored in the output properties defined above.</p><p>Close the loop by calling <span class="inlineCode"><code class="  language-swift"><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span><span class="token punctuation">)</span></code></span> on the output observables in the ViewController. Don't forget to put the results of the <span class="inlineCode"><code class="  language-swift"><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span><span class="token punctuation">)</span></code></span> calls in the <span class="inlineCode"><code class="  language-swift">bag</code></span> or to call <span class="inlineCode"><code class="  language-swift"><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></span> in <span class="inlineCode"><code class="  language-swift"><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></span>.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span> <span class="token operator">...</span>
                             
    <span class="token keyword">let</span> bag <span class="token operator">=</span> <span class="token class-name">DisposeBag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        
    <span class="token keyword">func</span> <span class="token function-definition function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        viewModel<span class="token punctuation">.</span>validatedEmail<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> result <span class="token keyword">in</span>
           <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">let</span> message<span class="token punctuation">)</span> <span class="token operator">=</span> result <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>text <span class="token operator">=</span> message
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">UIView</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span>withDuration<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">layoutIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> bag<span class="token punctuation">)</span>

        viewModel<span class="token punctuation">.</span>validatedPassword<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> result <span class="token keyword">in</span>
            <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">let</span> message<span class="token punctuation">)</span> <span class="token operator">=</span> result <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>text <span class="token operator">=</span> message
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">UIView</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span>withDuration<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">layoutIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> bag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><h2>The Getaway</h2><p>Add two more output properties to the ViewModel. The first is <span class="inlineCode"><code class="  language-swift">signingIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span></code></span> to manage the state of the current request so we can disable the sign in button when a request is in-flight. The second is the output Driver for the response from the network request to sign in.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">let</span> signingIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span>
<span class="token keyword">let</span> signedIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">LoginResponse</span><span class="token operator">&gt;</span></code></pre></div><p>The ViewModel snippet below is preparation to handle the sign in implementation. Compose the email and password text drivers (the inputs) with the validation result drivers (the outputs) in addition we create another Driver wrapped observable from a utility class borrowed from RxExample that provides the ability to track the activity of an observable so we can prevent the user from creating a duplicate request if one is already in-flight and the user mashes the sign in button.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">let</span> emailPassword <span class="token operator">=</span> <span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token function">combineLatest</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

<span class="token keyword">let</span> activity <span class="token operator">=</span> <span class="token class-name">ActivityIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
signingIn <span class="token operator">=</span> activity<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> validated <span class="token operator">=</span> <span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token function">combineLatest</span><span class="token punctuation">(</span>
    emailPassword<span class="token punctuation">,</span>
    validatedEmail<span class="token punctuation">,</span>
    validatedPassword<span class="token punctuation">,</span>
    signingIn
<span class="token punctuation">)</span></code></pre></div><p>Finally we hook everything together, there is a lot going on here so let's break it down line by line. First call <span class="inlineCode"><code class="  language-swift"><span class="token function">withLatestFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></span> on the <span class="inlineCode"><code class="  language-swift">signIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Void</span><span class="token operator">&gt;</span></code></span> passing in the combined inputs and outputs composed above (<span class="inlineCode"><code class="  language-swift">validated</code></span>). Then <span class="inlineCode"><code class="  language-swift">flatMapLatest</code></span> the sign in button tap event with the observables composition, guard for successful validation and no requests in flight, then <span class="inlineCode"><code class="  language-swift">flatMap</code></span> the observable from the network sign in request, check the response status (the example code is oversimplified but in a real world application here is where you determine error messsages to display if for instance the response was <i>401 unauthorized</i>) and return an <span class="inlineCode"><code class="  language-swift"><span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token class-name">LoginResponse</span><span class="token operator">&gt;</span></code></span>, add the activity tracking and finally build the <span class="inlineCode"><code class="  language-swift">signedIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">LoginResponse</span><span class="token operator">&gt;</span></code></span> output Driver.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift">signedIn <span class="token operator">=</span> signIn<span class="token punctuation">.</span><span class="token function">withLatestFrom</span><span class="token punctuation">(</span>validated<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span> combined <span class="token keyword">in</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>emailPassword<span class="token punctuation">,</span> validatedUsername<span class="token punctuation">,</span> validatedPassword<span class="token punctuation">,</span> signingIn<span class="token punctuation">)</span> <span class="token operator">=</span> combined
    <span class="token keyword">guard</span> <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>success<span class="token punctuation">,</span> <span class="token punctuation">.</span>success<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>validatedUsername<span class="token punctuation">,</span> validatedPassword<span class="token punctuation">,</span> signingIn<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token punctuation">.</span>validating<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Network</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> emailPassword<span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">,</span>
                                password<span class="token punctuation">:</span> emailPassword<span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> response <span class="token operator">-&gt;</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token class-name">LoginResponse</span><span class="token operator">&gt;</span> <span class="token keyword">in</span>
            <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span>success <span class="token operator">=</span> response <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token punctuation">.</span>success<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">trackActivity</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token punctuation">.</span>failure<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div><p>Now in the ViewController we use <span class="inlineCode"><code class="  language-swift"><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span><span class="token punctuation">)</span></code></span> to drive the state of the <span class="inlineCode"><code class="  language-swift">isEnabled</code></span> property of the sign in button and drive <span class="inlineCode"><code class="  language-swift">signedIn</code></span> to handle the result of the sign in network call. Again taking caution to use <span class="inlineCode"><code class="  language-swift"><span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span></code></span> and don't forget to dispose of the result of <span class="inlineCode"><code class="  language-swift">drive</code></span> in the bag.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift">viewModel<span class="token punctuation">.</span>signingIn<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> signingIn <span class="token keyword">in</span>
    <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>signIn<span class="token punctuation">.</span>isEnabled <span class="token operator">=</span> <span class="token operator">!</span>signingIn
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> bag<span class="token punctuation">)</span>

viewModel<span class="token punctuation">.</span>signedIn<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> signedIn <span class="token keyword">in</span>
    <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span>success <span class="token operator">=</span> signedIn <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>passwordError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">endEditing</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span>failure <span class="token operator">=</span> signedIn <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"Failed, please try again."</span></span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>passwordError<span class="token punctuation">.</span>text <span class="token operator">=</span> message
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>passwordError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>emailError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">UIView</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span>withDuration<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">layoutIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> bag<span class="token punctuation">)</span></code></pre></div><p>The success state is where the application would presumably handle navigating elsewhere or dismissing the sign in screen if presented modally. In a real world application the response should wrap a more informative error message that can then be displayed to the user.</p><h2>Test Drive</h2><p>What about unit testing the ViewModel you ask? Simple, since all the ViewModel knows is that it needs 3 Drivers we can provide those easily.</p><div class="code"><pre class="  language-swift" tabindex="0"><code class="centered  language-swift"><span class="token keyword">import</span> <span class="token class-name">XCTest</span>
<span class="token keyword">import</span> <span class="token class-name">RxSwift</span>
<span class="token keyword">import</span> <span class="token class-name">RxCocoa</span>

<span class="token attribute atrule">@testable</span> <span class="token keyword">import</span> <span class="token class-name">Drive</span>

<span class="token keyword">class</span> <span class="token class-name">TestDrive</span><span class="token punctuation">:</span> <span class="token class-name">XCTestCase</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> subject<span class="token punctuation">:</span> <span class="token class-name">ViewModel</span><span class="token operator">?</span>
    <span class="token keyword">let</span> bag <span class="token operator">=</span> <span class="token class-name">DisposeBag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">setUpWithError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
        
        <span class="token keyword">let</span> email<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"email@email"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">""</span></span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> password<span class="token punctuation">:</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"email@email"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> signIn<span class="token punctuation">:</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token class-name">Void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        subject <span class="token operator">=</span> <span class="token class-name">ViewModel</span><span class="token punctuation">(</span>
            email<span class="token punctuation">:</span> email<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            password<span class="token punctuation">:</span> password<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            signIn<span class="token punctuation">:</span> signIn<span class="token punctuation">.</span><span class="token function">asDriver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">testDrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
        <span class="token class-name">XCTAssertNotNil</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>
        subject<span class="token operator">?</span><span class="token punctuation">.</span>validatedEmail<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span>onNext<span class="token punctuation">:</span> <span class="token punctuation">{</span> result <span class="token keyword">in</span>
            <span class="token class-name">XCTAssertEqual</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Please enter a valid email address."</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disposed</span><span class="token punctuation">(</span>by<span class="token punctuation">:</span> bag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></div><h2>In the Bag</h2><p>That's the post, you can find the completed working project <a href="https://github.com/ScottORLY/drive">here</a>. Feel free to drop some feedback or questions on <a href="https://twitter.com/orlyck">Twitter</a> or you can go to the <a href="https://github.com/ScottORLY/drive-blog">source</a> of this blog post itself and create an issue or pull-request. Until next time.</p></div></div></body></html>